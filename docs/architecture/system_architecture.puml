@startuml AI-Trader System Architecture
!define RECTANGLE class

skinparam backgroundColor #FFFFFF
skinparam component {
    BackgroundColor<<main>> #E1F5FE
    BackgroundColor<<agent>> #FFF9C4
    BackgroundColor<<mcp>> #C8E6C9
    BackgroundColor<<data>> #FFECB3
    BackgroundColor<<tools>> #F0F4C3
    BorderColor #424242
    FontSize 12
}

title AI-Trader系统架构图

package "入口层 Entry" {
    [main.py] <<main>> as Main
    [配置文件\nconfigs/*.json] as Config
}

package "Agent层 Agent Layer" {
    [BaseAgentAStock\n(A股交易Agent)] <<agent>> as BaseAgentAStock
    [agent_prompt_astock.py\n(A股交易提示词)] <<agent>> as AgentPrompt
}

package "MCP工具链 MCP Toolchain" {
    [tool_trade.py\n交易执行] <<mcp>> as TradeTool
    [tool_get_price_local.py\n价格查询] <<mcp>> as PriceTool
    [tool_jina_search.py\n信息搜索] <<mcp>> as SearchTool
    [tool_math.py\n数学计算] <<mcp>> as MathTool
    [start_mcp_services.py\n启动服务] <<mcp>> as MCPStart
}

package "数据层 Data Layer" {
    database "A股数据" {
        [A_stock/merged.jsonl\n(SSE 50)] as CNData
        [agent_data_astock/\n(A股交易记录)] as CNAgentData
    }
}

package "工具层 Utility Layer" {
    [general_tools.py\n(配置管理)] <<tools>> as GeneralTools
    [price_tools.py\n(价格工具)] <<tools>> as PriceTools
    [result_tools.py\n(性能分析)] <<tools>> as ResultTools
}

package "外部服务 External Services" {
    cloud "OpenAI API\n(LLM推理)" as OpenAI
    cloud "Jina AI\n(信息搜索)" as Jina
    cloud "Tushare\n(A股数据)" as Tushare
}

' 主流程关系
Main --> Config : 读取配置
Main --> BaseAgentAStock : 创建A股Agent

' Agent与工具关系
BaseAgentAStock --> AgentPrompt : 使用A股提示词
BaseAgentAStock ..> TradeTool : MCP调用
BaseAgentAStock ..> PriceTool : MCP调用
BaseAgentAStock ..> SearchTool : MCP调用
BaseAgentAStock ..> MathTool : MCP调用

' Agent与数据关系
BaseAgentAStock --> CNData : 读取A股价格
BaseAgentAStock --> CNAgentData : 写入A股交易

' Agent与工具层关系
BaseAgentAStock --> GeneralTools : 配置管理
BaseAgentAStock --> PriceTools : 价格查询

' 工具与数据关系
TradeTool --> CNAgentData : 写入持仓
PriceTool --> CNData : 读取价格
PriceTools --> CNData : 读取价格

' 外部服务关系
BaseAgentAStock --> OpenAI : LLM推理
SearchTool --> Jina : 搜索请求
CNData <.. Tushare : 数据获取

note right of Main
  专注A股市场
  支持多模型并行
  自动加载BaseAgentAStock
  环境变量配置
end note

note right of BaseAgentAStock
  A股专用Agent
  上证50股票池
  T+1交易规则
  100股手数验证
  MCP工具驱动
  完整历史回放
end note

note bottom of TradeTool
  A股交易规则
  - T+1结算
  - 100股为一手
  - 人民币计价
  - 文件锁保证原子性
end note

note bottom of CNData
  上证50成分股
  Tushare数据源
  日线级别数据
  JSONL统一格式
end note

@enduml