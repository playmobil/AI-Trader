@startuml AI-Trader Data Flow
!theme plain
skinparam backgroundColor #FFFFFF

title AI-Trader数据流图

skinparam component {
    BackgroundColor<<config>> #E1F5FE
    BackgroundColor<<market>> #FFF9C4
    BackgroundColor<<position>> #C8E6C9
    BackgroundColor<<log>> #FFECB3
    BackgroundColor<<runtime>> #F3E5F5
    BorderColor #424242
}

' 配置数据流
package "配置数据流 Configuration Flow" {
    file ".env" as ENV <<config>>
    file "configs/*.json" as ConfigJSON <<config>>
    file "runtime_env.json" as RuntimeEnv <<runtime>>

    note right of ENV
      ENV : OPENAI_API_KEY
      ENV : OPENAI_API_BASE
      ENV : ALPHAADVANTAGE_API_KEY
      ENV : JINA_API_KEY
      ENV : TUSHARE_TOKEN
      ENV : BINANCE_API_KEY
      ENV : RUNTIME_ENV_PATH
      ENV : MATH_HTTP_PORT=8000
      ENV : ...
    end note

    note right of ConfigJSON
      ConfigJSON : agent_type
      ConfigJSON : market
      ConfigJSON : date_range
      ConfigJSON : models[]
      ConfigJSON : agent_config
    end note

    note right of RuntimeEnv
      RuntimeEnv : SIGNATURE
      RuntimeEnv : TODAY_DATE
      RuntimeEnv : MARKET
      RuntimeEnv : IF_TRADE
      RuntimeEnv : LOG_FILE
      RuntimeEnv : LOG_PATH
    end note
}

' 市场数据流
package "市场数据流 Market Data Flow" {
    cloud "Alpha Vantage API" as AlphaAPI
    cloud "Tushare API" as TushareAPI
    cloud "Binance API" as BinanceAPI

    file "data/daily_prices_*.json" as DailyJSON <<market>>
    file "data/merged.jsonl" as USMerged <<market>>
    file "data/A_stock/merged.jsonl" as CNMerged <<market>>
    file "data/crypto/merged.jsonl" as CryptoMerged <<market>>

    note right of DailyJSON
      DailyJSON : Symbol: AAPL
      DailyJSON : Time Series (Daily)
      DailyJSON : - date: OHLCV
    end note

    note right of USMerged
      USMerged : {Meta Data, Time Series}
      USMerged : 统一JSONL格式
      USMerged : NASDAQ 100所有股票
      USMerged : ---
      USMerged : **统一数据格式**
      USMerged : - JSONL行式存储
      USMerged : - 每行一个股票的完整历史
      USMerged : - 支持高效日期查询
      USMerged : - 自动过滤未来数据
    end note

    note right of CNMerged
      CNMerged : {Meta Data, Time Series}
      CNMerged : 统一JSONL格式
      CNMerged : 上证50所有股票
    end note

    note right of CryptoMerged
      CryptoMerged : {Meta Data, Time Series}
      CryptoMerged : 统一JSONL格式
      CryptoMerged : 主流加密货币(USDT交易对)
      CryptoMerged : ---
      CryptoMerged : **加密货币数据特点**
      CryptoMerged : - 7×24小时连续数据
      CryptoMerged : - USDT交易对
      CryptoMerged : - 分钟级/小时级数据
      CryptoMerged : - 实时更新
    end note
}

' 持仓数据流
package "持仓数据流 Position Flow" {
    file "agent_data/{signature}/\nposition/position.jsonl" as USPosition <<position>>
    file "agent_data_astock/{signature}/\nposition/position.jsonl" as CNPosition <<position>>
    file "agent_data_crypto/{signature}/\nposition/position.jsonl" as CryptoPosition <<position>>

    note right of USPosition
      USPosition : date
      USPosition : id
      USPosition : this_action
      USPosition :   - action (buy/sell/hold)
      USPosition :   - symbol
      USPosition :   - amount
      USPosition : positions
      USPosition :   - {symbol}: quantity
      USPosition :   - CASH: balance
      USPosition : ---
      USPosition : **持仓记录特点**
      USPosition : - 追加写入(append-only)
      USPosition : - 文件锁保证原子性
      USPosition : - 每次交易创建新记录
      USPosition : - 保留完整历史轨迹
    end note

    note right of CNPosition
      CNPosition : date
      CNPosition : id
      CNPosition : this_action
      CNPosition :   - action (buy/sell/hold)
      CNPosition :   - symbol (带.SH/.SZ后缀)
      CNPosition :   - amount (100股为单位)
      CNPosition : positions
      CNPosition :   - {symbol}: quantity
      CNPosition :   - CASH: balance
    end note

    note right of CryptoPosition
      CryptoPosition : date
      CryptoPosition : id
      CryptoPosition : this_action
      CryptoPosition :   - action (buy/sell/hold)
      CryptoPosition :   - symbol (带-USDT后缀)
      CryptoPosition :   - amount
      CryptoPosition : positions
      CryptoPosition :   - {symbol}: quantity
      CryptoPosition :   - CASH: USDT balance
      CryptoPosition : ---
      CryptoPosition : **加密货币持仓特点**
      CryptoPosition : - CASH用USDT计价
      CryptoPosition : - 支持小数精度
      CryptoPosition : - 无手数限制
      CryptoPosition : - 7×24小时可交易
    end note
}

' 日志数据流
package "日志数据流 Log Flow" {
    file "agent_data/{signature}/\nlog/{date}/log.jsonl" as USLog <<log>>
    file "agent_data_astock/{signature}/\nlog/{date}/log.jsonl" as CNLog <<log>>
    file "agent_data_crypto/{signature}/\nlog/{date}/log.jsonl" as CryptoLog <<log>>

    note right of USLog
      USLog : signature
      USLog : new_messages[]
      USLog :   - role (assistant/user/system)
      USLog :   - content
      USLog :     * AI分析内容
      USLog :     * Tool调用请求
      USLog :     * Tool返回结果
      USLog : ---
      USLog : **日志记录内容**
      USLog : - AI完整推理过程
      USLog : - 工具调用及结果
      USLog : - 按日期分目录存储
      USLog : - 可用于调试和分析
    end note

    note right of CNLog
      CNLog : signature
      CNLog : new_messages[]
      CNLog :   - role (assistant/user/system)
      CNLog :   - content
      CNLog :     * A股市场分析
      CNLog :     * Tool调用请求
      CNLog :     * Tool返回结果
    end note

    note right of CryptoLog
      CryptoLog : signature
      CryptoLog : new_messages[]
      CryptoLog :   - role (assistant/user/system)
      CryptoLog :   - content
      CryptoLog :     * 加密货币分析
      CryptoLog :     * Tool调用请求
      CryptoLog :     * Tool返回结果
    end note
}

' 主程序
rectangle "main.py" as Main {
}

' Agent层
rectangle "BaseAgent/\nBaseAgentAStock/\nBaseAgentCrypto" as Agent {
}

' MCP工具层
rectangle "MCP Tools" as MCP {
    component "tool_trade" as Trade
    component "tool_get_price_local" as Price
    component "tool_jina_search" as Search
}

' 工具层
rectangle "Utility Tools" as Utils {
    component "general_tools" as GenTools
    component "price_tools" as PriceTools
}

' ==== 数据流向 ====

' 配置数据流向
ENV -down-> Main : 读取环境变量
ConfigJSON -down-> Main : 加载配置文件
Main -down-> RuntimeEnv : 写入运行时配置
RuntimeEnv <--> GenTools : 读写配置
GenTools <--> Agent : 配置管理
GenTools <--> MCP : 配置读取

' 市场数据获取流
AlphaAPI ..> DailyJSON : 获取数据\n(get_daily_price.py)
DailyJSON ..> USMerged : 合并转换\n(merge_jsonl.py)
TushareAPI ..> CNMerged : 获取并转换\n(get_daily_price_a_stock.py\n + merge_a_stock_jsonl.py)
BinanceAPI ..> CryptoMerged : 获取并转换\n(get_crypto_price.py\n + merge_crypto_jsonl.py)

' 市场数据读取流
USMerged -down-> PriceTools : 读取US价格
CNMerged -down-> PriceTools : 读取CN价格
CryptoMerged -down-> PriceTools : 读取Crypto价格
PriceTools -down-> Agent : 提供价格数据
USMerged -down-> Price : MCP读取价格
CNMerged -down-> Price : MCP读取价格
CryptoMerged -down-> Price : MCP读取价格

' 持仓数据流
Agent --> USPosition : 初始化\n注册Agent
Agent --> CNPosition : 初始化\n注册Agent
Agent --> CryptoPosition : 初始化\n注册Agent
USPosition <--> Trade : 读写US持仓
CNPosition <--> Trade : 读写CN持仓
CryptoPosition <--> Trade : 读写Crypto持仓
USPosition <--> PriceTools : 读取持仓
CNPosition <--> PriceTools : 读取持仓
CryptoPosition <--> PriceTools : 读取持仓
Trade --> Agent : 返回交易结果

' 日志数据流
Agent -down-> USLog : 记录US交易日志
Agent -down-> CNLog : 记录CN交易日志
Agent -down-> CryptoLog : 记录Crypto交易日志

' Agent与工具交互
Main -down-> Agent : 创建并初始化
Agent <--> MCP : MCP工具调用
Agent --> Search : 信息搜索

note top of RuntimeEnv
  **运行时共享配置**
  - 所有Agent实例共享
  - 文件锁保证并发安全
  - 存储当前执行上下文
end note

legend right
  |<#E1F5FE> 配置数据 |
  |<#FFF9C4> 市场数据 |
  |<#C8E6C9> 持仓数据 |
  |<#FFECB3> 日志数据 |
  |<#F3E5F5> 运行时配置 |
endlegend

@enduml