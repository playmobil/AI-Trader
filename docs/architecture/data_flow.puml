@startuml AI-Trader Data Flow (A股专版)
!theme plain
skinparam backgroundColor #FFFFFF

title AI-Trader数据流图 - A股市场

skinparam component {
    BackgroundColor<<config>> #E1F5FE
    BackgroundColor<<market>> #FFF9C4
    BackgroundColor<<position>> #C8E6C9
    BackgroundColor<<log>> #FFECB3
    BackgroundColor<<runtime>> #F3E5F5
    BorderColor #424242
}

' 配置数据流
package "配置数据流 Configuration Flow" {
    file ".env" as ENV <<config>>
    file "configs/astock_config.json" as ConfigJSON <<config>>
    file "runtime_env.json" as RuntimeEnv <<runtime>>

    note right of ENV
      ENV : OPENAI_API_KEY
      ENV : OPENAI_API_BASE
      ENV : JINA_API_KEY
      ENV : TUSHARE_TOKEN
      ENV : RUNTIME_ENV_PATH
      ENV : MATH_HTTP_PORT=8000
      ENV : SEARCH_HTTP_PORT=8001
      ENV : TRADE_HTTP_PORT=8002
      ENV : GETPRICE_HTTP_PORT=8003
    end note

    note right of ConfigJSON
      ConfigJSON : agent_type = "BaseAgentAStock"
      ConfigJSON : market = "cn"
      ConfigJSON : date_range
      ConfigJSON :   - init_date
      ConfigJSON :   - end_date
      ConfigJSON : models[]
      ConfigJSON : agent_config
      ConfigJSON :   - initial_cash = 100000.0
    end note

    note right of RuntimeEnv
      RuntimeEnv : SIGNATURE
      RuntimeEnv : TODAY_DATE
      RuntimeEnv : MARKET = "cn"
      RuntimeEnv : IF_TRADE
      RuntimeEnv : LOG_FILE
      RuntimeEnv : LOG_PATH
    end note
}

' A股市场数据流
package "A股市场数据流 A-Stock Market Data Flow" {
    cloud "Tushare API" as TushareAPI

    file "data/A_stock/sse_50_weight.csv" as SSE50CSV <<market>>
    file "data/A_stock/daily_prices_sse_50.csv" as DailyCSV <<market>>
    file "data/A_stock/merged.jsonl" as CNMerged <<market>>
    file "data/A_stock/index_daily_sse_50.json" as IndexJSON <<market>>

    note right of SSE50CSV
      上证50成分股列表
      - 股票代码
      - 权重信息
      - 定期更新
    end note

    note right of CNMerged
      {Meta Data, Time Series}
      统一JSONL格式
      上证50所有股票
      ---
      **A股数据特点**
      - JSONL行式存储
      - 每行一个股票的完整历史
      - 支持高效日期查询
      - 自动过滤未来数据
      - T+1交易日历
      - 股票代码格式: XXXXXX.SH/SZ
    end note

    note right of IndexJSON
      上证50指数数据
      - 指数日线数据
      - 用于基准对比
      - 绩效评估
    end note
}

' A股持仓数据流
package "A股持仓数据流 A-Stock Position Flow" {
    file "agent_data_astock/{signature}/\nposition/position.jsonl" as CNPosition <<position>>

    note right of CNPosition
      CNPosition : date
      CNPosition : id
      CNPosition : this_action
      CNPosition :   - action (buy/sell/hold)
      CNPosition :   - symbol (带.SH/.SZ后缀)
      CNPosition :   - amount (100股为单位)
      CNPosition : positions
      CNPosition :   - {symbol}: quantity
      CNPosition :   - CASH: balance (人民币)
      CNPosition : ---
      CNPosition : **A股持仓特点**
      CNPosition : - 追加写入(append-only)
      CNPosition : - 文件锁保证原子性
      CNPosition : - 每次交易创建新记录
      CNPosition : - 保留完整历史轨迹
      CNPosition : - 100股手数验证
      CNPosition : - T+1结算
    end note
}

' A股日志数据流
package "A股日志数据流 A-Stock Log Flow" {
    file "agent_data_astock/{signature}/\nlog/{date}/log.jsonl" as CNLog <<log>>

    note right of CNLog
      CNLog : signature
      CNLog : new_messages[]
      CNLog :   - role (assistant/user/system)
      CNLog :   - content
      CNLog :     * A股市场分析
      CNLog :     * 中文推理过程
      CNLog :     * Tool调用请求
      CNLog :     * Tool返回结果
      CNLog : ---
      CNLog : **A股日志特点**
      CNLog : - AI完整推理过程
      CNLog : - 中文市场分析
      CNLog : - 工具调用及结果
      CNLog : - 按日期分目录存储
      CNLog : - 可用于调试和分析
    end note
}

' 主程序
rectangle "main.py" as Main {
}

' Agent层
rectangle "BaseAgentAStock" as Agent {
}

' MCP工具层
rectangle "MCP Tools" as MCP {
    component "tool_trade\n(A股交易)" as Trade
    component "tool_get_price_local\n(A股价格查询)" as Price
    component "tool_jina_search\n(市场信息)" as Search
    component "tool_math\n(计算工具)" as Math
}

' 工具层
rectangle "Utility Tools" as Utils {
    component "general_tools\n(配置管理)" as GenTools
    component "price_tools\n(A股价格工具)" as PriceTools
    component "result_tools\n(绩效分析)" as ResultTools
}

' ==== 数据流向 ====

' 配置数据流向
ENV -down-> Main : 读取环境变量
ConfigJSON -down-> Main : 加载A股配置
Main -down-> RuntimeEnv : 写入运行时配置\n(MARKET="cn")
RuntimeEnv <--> GenTools : 读写配置
GenTools <--> Agent : 配置管理
GenTools <--> MCP : 配置读取

' A股市场数据获取流
TushareAPI ..> SSE50CSV : 获取成分股列表
TushareAPI ..> DailyCSV : 获取日线数据
TushareAPI ..> IndexJSON : 获取指数数据
DailyCSV ..> CNMerged : 合并转换\n(merge_a_stock_jsonl.py)

' A股市场数据读取流
CNMerged -down-> PriceTools : 读取A股价格
PriceTools -down-> Agent : 提供价格数据
CNMerged -down-> Price : MCP读取价格

' A股持仓数据流
Agent --> CNPosition : 初始化注册\n(初始资金¥100,000)
CNPosition <--> Trade : 读写A股持仓\n(100股手数验证)
CNPosition <--> PriceTools : 读取持仓
Trade --> Agent : 返回交易结果

' A股日志数据流
Agent -down-> CNLog : 记录A股交易日志\n(中文分析)

' Agent与工具交互
Main -down-> Agent : 创建BaseAgentAStock
Agent <--> MCP : MCP工具调用
Agent --> Search : 信息搜索
Agent --> Math : 数学计算

' 绩效分析
CNPosition --> ResultTools : 读取历史持仓
IndexJSON --> ResultTools : 对比基准指数
ResultTools --> Agent : 生成绩效报告

note top of RuntimeEnv
  **运行时共享配置**
  - 所有Agent实例共享
  - 文件锁保证并发安全
  - 存储当前执行上下文
  - Market固定为"cn"
end note

note bottom of TushareAPI
  **Tushare数据源**
  - 中国A股专业数据
  - 需要token认证
  - 支持历史数据
  - 日线/分钟线数据
  - 成分股信息
end note

note bottom of Trade
  **A股交易特点**
  - T+1结算规则
  - 100股为一手
  - 买入验证手数
  - 卖出验证持仓
  - 人民币计价
  - 文件锁保证原子性
end note

legend right
  |<#E1F5FE> 配置数据 |
  |<#FFF9C4> A股市场数据 |
  |<#C8E6C9> A股持仓数据 |
  |<#FFECB3> A股日志数据 |
  |<#F3E5F5> 运行时配置 |
endlegend

@enduml
