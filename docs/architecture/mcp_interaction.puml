@startuml MCP Tool Interaction (A股专版)
!theme plain
skinparam backgroundColor #FFFFFF

title MCP工具交互图 - A股市场

participant "BaseAgentAStock" as Agent
participant "MCP Client" as Client
participant "Trade Tool\n(Port 8002)" as Trade
participant "Price Tool\n(Port 8003)" as Price
participant "Search Tool\n(Port 8001)" as Search
participant "Math Tool\n(Port 8000)" as Math
database "Position File\n(A股)" as PosFile
database "Price Data\n(A股)" as PriceData
boundary "Jina AI" as Jina

== MCP工具初始化 ==

Agent -> Client: 初始化MultiServerMCPClient(mcp_config)
activate Client

Client -> Trade: 连接 http://localhost:8002/mcp
activate Trade
Trade --> Client: 注册工具: buy(), sell()
deactivate Trade

Client -> Price: 连接 http://localhost:8003/mcp
activate Price
Price --> Client: 注册工具: get_price_local()
deactivate Price

Client -> Search: 连接 http://localhost:8001/mcp
activate Search
Search --> Client: 注册工具: get_information()
deactivate Search

Client -> Math: 连接 http://localhost:8000/mcp
activate Math
Math --> Client: 注册工具: calculate()
deactivate Math

Client --> Agent: 返回工具列表\n[buy, sell, get_price_local, get_information, calculate]
deactivate Client

note right of Agent
  A股Agent初始化完成
  - Market: "cn"
  - 上证50股票池
  - T+1交易规则
  - 100股手数验证
end note

== 工具调用示例：A股价格查询 ==

Agent -> Client: 调用工具\nget_price_local(symbol="600519.SH", date="2025-10-15")
activate Client

Client -> Price: HTTP POST /mcp\n{"tool": "get_price_local", "params": {...}}
activate Price

Price -> PriceData: 读取 A_stock/merged.jsonl\n查询 600519.SH 在 2025-10-15 的数据
activate PriceData
PriceData --> Price: 返回A股价格数据\n{open: 1850.00, close: 1865.50, ...}
deactivate PriceData

Price --> Client: 返回结果
deactivate Price

Client --> Agent: 工具执行结果
deactivate Client

note right of Price
  **A股价格查询逻辑**
  1. 从A_stock/merged.jsonl读取
  2. 识别.SH/.SZ后缀
  3. 过滤到指定日期
  4. 验证不返回未来数据
  5. 返回OHLCV数据
  6. 人民币计价
end note

== 工具调用示例：A股信息搜索 ==

Agent -> Client: 调用工具\nget_information(query="贵州茅台最新财报")
activate Client

Client -> Search: HTTP POST /mcp\n{"tool": "get_information", "params": {...}}
activate Search

Search -> Jina: API请求\nJINA_API_KEY认证\n中文查询
activate Jina
Jina --> Search: 返回中文搜索结果
deactivate Jina

Search --> Client: 返回整理后的信息
deactivate Search

Client --> Agent: 工具执行结果
deactivate Client

note right of Search
  **信息搜索特点**
  - 调用Jina AI API
  - 支持中文查询
  - A股实时市场信息
  - 财报、公告、新闻
  - 可配置搜索范围
end note

== 工具调用示例：A股买入交易 ==

Agent -> Client: 调用工具\nbuy(symbol="600519.SH", amount=200)
activate Client

Client -> Trade: HTTP POST /mcp\n{"tool": "buy", "params": {...}}
activate Trade

Trade -> Trade: 检测市场类型\n(.SH后缀 -> A股市场)

Trade -> Trade: 获取配置\nSIGNATURE, TODAY_DATE, MARKET="cn"

Trade -> Trade: 验证手数\n200 % 100 == 0 ✓

Trade -> Trade: 获取文件锁\n_position_lock(signature)

Trade -> PosFile: 读取最新持仓\nget_latest_position()
activate PosFile
PosFile --> Trade: 返回当前持仓\n{600519.SH: 0, CASH: 100000.0}
deactivate PosFile

Trade -> PriceData: 获取开盘价\nget_open_prices(TODAY_DATE, ["600519.SH"])
activate PriceData
PriceData --> Trade: 返回价格 {600519.SH: 1850.00}
deactivate PriceData

Trade -> Trade: 验证交易条件\n✓ 现金充足: 100000 >= 370000 ✗\n需要更多资金!

Trade --> Client: 返回错误\n{"error": "现金不足", ...}
deactivate Trade

Client --> Agent: 工具执行结果(失败)
deactivate Client

note right of Trade
  **A股买入逻辑**
  1. 检测.SH/.SZ后缀
  2. 验证100股手数
  3. 获取文件锁
  4. 读取当前持仓
  5. 获取当日开盘价
  6. 验证现金充足
  7. 计算新持仓
  8. 写入position.jsonl
  9. 释放文件锁
end note

== 工具调用示例：A股买入交易(成功) ==

Agent -> Client: 调用工具\nbuy(symbol="600036.SH", amount=100)
activate Client

Client -> Trade: HTTP POST /mcp\n{"tool": "buy", "params": {...}}
activate Trade

Trade -> Trade: 检测市场类型(.SH -> A股)\n验证手数: 100 % 100 == 0 ✓

Trade -> Trade: 获取文件锁

Trade -> PosFile: 读取最新持仓
activate PosFile
PosFile --> Trade: 返回当前持仓\n{600036.SH: 0, CASH: 100000.0}
deactivate PosFile

Trade -> PriceData: 获取开盘价
activate PriceData
PriceData --> Trade: 返回价格 {600036.SH: 45.80}
deactivate PriceData

Trade -> Trade: 验证交易条件\n✓ 现金充足: 100000 >= 4580\n✓ 100股手数验证通过

Trade -> Trade: 计算新持仓\n600036.SH: 0 + 100 = 100\nCASH: 100000 - 4580 = 95420.0

Trade -> PosFile: 写入新持仓记录\n(追加模式, append-only)
activate PosFile
PosFile --> Trade: 写入成功
deactivate PosFile

Trade -> Trade: 释放文件锁

Trade --> Client: 返回成功\n{600036.SH: 100, CASH: 95420.0, ...}
deactivate Trade

Client --> Agent: 工具执行结果(成功)
deactivate Client

== 工具调用示例：A股卖出交易 ==

Agent -> Client: 调用工具\nsell(symbol="600036.SH", amount=100)
activate Client

Client -> Trade: HTTP POST /mcp\n{"tool": "sell", "params": {...}}
activate Trade

Trade -> Trade: 检测市场类型\n(.SH后缀 -> A股市场)

Trade -> Trade: 验证手数\n100 % 100 == 0 ✓

Trade -> Trade: 获取文件锁

Trade -> PosFile: 读取最新持仓
activate PosFile
PosFile --> Trade: 返回当前持仓\n{600036.SH: 100, CASH: 95420.0}
deactivate PosFile

Trade -> Trade: 验证持仓数量\n100 >= 100 ✓

Trade -> PriceData: 获取开盘价
activate PriceData
PriceData --> Trade: 返回价格 {600036.SH: 46.50}
deactivate PriceData

Trade -> Trade: 计算新持仓\n600036.SH: 100 - 100 = 0\nCASH: 95420 + 4650 = 100070.0

Trade -> PosFile: 写入新持仓记录
activate PosFile
PosFile --> Trade: 写入成功
deactivate PosFile

Trade -> Trade: 释放文件锁

Trade --> Client: 返回成功\n{600036.SH: 0, CASH: 100070.0, ...}
deactivate Trade

Client --> Agent: 工具执行结果(成功)
deactivate Client

note right of Trade
  **A股交易核心规则**
  1. 市场检测 (CN A股)
  2. 规则验证
     - T+1结算
     - 100股为一手
     - 人民币计价
  3. 文件锁保证并发安全
  4. 原子性更新持仓
  5. 完整记录交易历史
  6. 股票代码格式: XXXXXX.SH/SZ
end note

== 工具调用示例：数学计算 ==

Agent -> Client: 调用工具\ncalculate(expression="(1865.50 - 1850.00) / 1850.00 * 100")
activate Client

Client -> Math: HTTP POST /mcp\n{"tool": "calculate", "params": {...}}
activate Math

Math -> Math: 安全计算表达式\n结果: 0.838

Math --> Client: 返回计算结果: 0.838
deactivate Math

Client --> Agent: 工具执行结果
deactivate Client

note right of Math
  **数学工具**
  - 安全的表达式计算
  - 支持基本数学运算
  - 避免eval安全问题
  - 用于收益率等计算
end note

== 数据存储说明 ==

note over PosFile
  **A股持仓文件特点**
  - 路径: agent_data_astock/{signature}/position/
  - 格式: position.jsonl
  - 追加写入模式
  - 文件锁保证原子性
  - 记录完整交易历史
  - 人民币计价
end note

note over PriceData
  **A股价格数据**
  - 路径: data/A_stock/merged.jsonl
  - 数据源: Tushare API
  - 上证50成分股
  - JSONL格式存储
  - T+1交易日历
  - 自动过滤未来数据
end note


@enduml
