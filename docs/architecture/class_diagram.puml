@startuml AI-Trader Class Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam class {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    ArrowColor #424242
}

title AI-Trader核心类图

package "langchain_openai" {
    class ChatOpenAI {
        <<基础LLM类>>
        + model: str
        + base_url: str
        + api_key: str
        + max_retries: int
        + timeout: int

        + __init__(...)
        + _generate(messages, stop, **kwargs)
        + _agenerate(messages, stop, **kwargs)
    }

    class DeepSeekChatOpenAI {
        <<ChatOpenAI扩展>>
        + _create_message_dicts(messages, stop): list
        + _generate(messages, stop, **kwargs)
        + _agenerate(messages, stop, **kwargs)

        .. 说明 ..
        处理DeepSeek API的
        tool_calls.args格式差异
    }
}

package "agent.base_agent_astock" {
    class BaseAgentAStock {
        <<A股交易Agent>>

        # 核心属性
        - signature: str
        - basemodel: str
        - market: str = "cn"
        - stock_symbols: List[str]
        - max_steps: int
        - max_retries: int
        - base_delay: float
        - initial_cash: float = 100000.0
        - init_date: str

        # 组件
        - client: MultiServerMCPClient
        - tools: List
        - model: ChatOpenAI
        - agent: Any
        - data_path: str
        - position_file: str

        # 默认常量
        + DEFAULT_STOCK_SYMBOLS: List[str]

        # 核心方法
        + __init__(signature, basemodel, ...)
        + initialize(): None
        + run_trading_session(today_date): None
        + run_date_range(init_date, end_date): None
        + register_agent(): None
        + get_trading_dates(init_date, end_date): List[str]
        + get_position_summary(): Dict

        # 私有方法
        - _get_default_mcp_config(): Dict
        - _setup_logging(today_date): str
        - _log_message(log_file, messages): None
        - _ainvoke_with_retry(message): Any
        - _handle_trading_result(today_date): None

        .. A股特性 ..
        - 上证50股票池
        - T+1结算规则
        - 100股手数验证
        - 人民币计价
        - 中文提示词
    }
}

package "main" {
    class AgentRegistry {
        <<注册表>>
        + AGENT_REGISTRY: Dict
        --
        "BaseAgentAStock": {"module": "agent.base_agent_astock.base_agent_astock","class": "BaseAgentAStock"}
    }

    class MainModule {
        <<主程序>>
        + get_agent_class(agent_type): Class
        + load_config(config_path): Dict
        + main(config_path): None
        --
        专注A股市场
        自动设置market="cn"
    }
}

package "agent_tools (MCP)" {
    interface MCPTool {
        + execute(params): Result
    }

    class TradeTool {
        + buy(symbol, amount): Dict
        + sell(symbol, amount): Dict
        - _position_lock(signature): Lock
        --
        自动检测市场规则
        文件锁保证原子性
    }

    class PriceTool {
        + get_price_local(symbol, date): Dict
        + get_open_prices(date, symbols): Dict
        --
        从merged.jsonl读取
        支持US和CN市场
    }

    class SearchTool {
        + get_information(query): str
        --
        调用Jina AI API
    }

    class MathTool {
        + calculate(expression): float
    }
}

package "tools (Utilities)" {
    class GeneralTools {
        + get_config_value(key): Any
        + write_config_value(key, value): None
        + extract_conversation(response, mode): str
        + extract_tool_messages(response): List
        - _resolve_runtime_env_path(): Path
        --
        管理共享运行时配置
        使用文件锁保证并发安全
    }

    class PriceTools {
        + get_open_prices(date, symbols, market): Dict
        + get_yesterday_open_and_close_price(...): Tuple
        + get_today_init_position(date, signature): Dict
        + get_latest_position(signature): Tuple
        + is_trading_day(date, market): bool
        + add_no_trade_record(date, signature): None
        --
        价格数据查询和处理
        持仓文件读写
    }

    class ResultTools {
        + calculate_performance(signature): Dict
        + analyze_trades(signature): Dict
        --
        性能指标计算
        交易分析
    }
}

package "prompts" {
    class AgentPromptAStock {
        + STOP_SIGNAL: str
        + all_sse_50_symbols: List[str]
        + get_agent_system_prompt(date, signature, symbols): str
        --
        A股专用提示词
        动态生成系统提示词
        包含当前A股价格和持仓
        中文市场分析提示
    }
}

' 继承关系
ChatOpenAI <|-- DeepSeekChatOpenAI

' 组合关系
BaseAgentAStock o-- "1" MultiServerMCPClient : client
BaseAgentAStock o-- "1..*" MCPTool : tools
BaseAgentAStock o-- "1" ChatOpenAI : model
BaseAgentAStock *-- DeepSeekChatOpenAI : uses (for DeepSeek models)

' 实现关系
MCPTool <|.. TradeTool
MCPTool <|.. PriceTool
MCPTool <|.. SearchTool
MCPTool <|.. MathTool

' 依赖关系
MainModule ..> AgentRegistry : uses
MainModule ..> BaseAgentAStock : creates
BaseAgentAStock ..> GeneralTools : uses
BaseAgentAStock ..> PriceTools : uses
BaseAgentAStock ..> AgentPromptAStock : uses
TradeTool ..> PriceTools : uses
TradeTool ..> GeneralTools : uses
PriceTool ..> PriceTools : uses

note top of BaseAgentAStock
  A股交易核心Agent
  - 专注中国A股市场
  - 上证50成分股池
  - T+1结算规则
  - 100股手数验证
  - MCP工具驱动
  - 完整历史回放
  - 人民币计价
end note

note right of DeepSeekChatOpenAI
  处理DeepSeek API特殊性
  tool_calls.args可能是
  JSON字符串而非dict
  自动转换为dict格式
end note

note bottom of TradeTool
  A股交易执行核心
  - T+1结算规则
  - 100股手数验证
  - 文件锁保证并发安全
  - 持仓原子性更新
  - 完整交易历史记录
end note

note bottom of PriceTool
  A股价格查询
  - 从merged.jsonl读取
  - 支持历史回放
  - 自动过滤未来数据
  - Tushare数据源
end note

note bottom of GeneralTools
  共享配置管理
  使用RUNTIME_ENV_PATH
  文件存储关键运行时信息:
  - SIGNATURE
  - TODAY_DATE
  - MARKET (固定为"cn")
  - IF_TRADE
  - LOG_FILE
  - LOG_PATH
end note

@enduml
